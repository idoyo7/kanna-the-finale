name: Docker Image Build & Update Manifest

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production # ì—¬ê¸°ì„œ í™˜ê²½ì„ ì„ ì–¸

    steps:
      # 1. ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # 3. ë¬´ì‘ìœ„ íƒœê·¸ ìƒì„±
      - name: Generate random tag for Docker image
        id: vars
        run: echo "IMAGE_TAG=$(date +%s | sha256sum | cut -c1-6)" >> $GITHUB_ENV

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        run: |
          docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/kanna:${{ env.IMAGE_TAG }}" .
          docker push "${{ secrets.DOCKERHUB_USERNAME }}/kanna:${{ env.IMAGE_TAG }}"

      # 5. rollout.yaml ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (GitOps ë°©ì‹)
      - name: Update image tag in rollout.yaml
        run: |
          # manifest ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
          mkdir -p manifest
          # rollout.yaml íŒŒì¼ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ì¶œë ¥ í›„ ì¢…ë£Œ
          if [ ! -f manifest/rollout.yaml ]; then
            echo "Error: manifest/rollout.yaml not found"
            ls -la manifest/
            exit 1
          fi
          # rollout.yamlì˜ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (ë” êµ¬ì²´ì ì¸ íŒ¨í„´)
          sed -i 's|image: idoyo7/kanna:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/kanna:${{ env.IMAGE_TAG }}|g' manifest/rollout.yaml
          # ë³€ê²½ ì‚¬í•­ í™•ì¸
          echo "Updated image in rollout.yaml:"
          grep "image:" manifest/rollout.yaml

      # 6. ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ (ArgoCDê°€ ê°ì§€í•˜ì—¬ ìë™ ë°°í¬)
      - name: Commit and push changes for GitOps
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          # ArgoCDê°€ ê°ì§€í•  ìˆ˜ ìˆë„ë¡ rollout.yaml ì»¤ë°‹
          git add -f manifest/rollout.yaml
          git commit -m "ğŸš€ Update image tag to ${{ env.IMAGE_TAG }} for ArgoRollout deployment"
          git push

